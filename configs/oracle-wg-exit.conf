[Interface]
# Oracle (Gateway Node) WireGuard Configuration
# Replace <oracle-private-key> with the actual private key from /etc/wireguard/oracle-private.key

PrivateKey = <oracle-private-key>
Address = 172.16.99.1/30
ListenPort = 51820
MTU = 1340
Table = off

# Enable IP forwarding
PostUp = sysctl -w net.ipv4.ip_forward=1

# Mark packets from Tailscale clients destined for internet (not Tailscale network or local network)
PostUp = iptables -t mangle -A PREROUTING -i tailscale0 ! -d 100.64.0.0/10 -j MARK --set-mark 99
PostUp = iptables -t mangle -A PREROUTING -i tailscale0 ! -d 10.0.0.0/8 -j MARK --set-mark 99

# Route marked packets through WireGuard tunnel
PostUp = ip route add default dev wg-exit table 100
PostUp = ip rule add fwmark 99 table 100 priority 100

# NAT traffic going through the tunnel
PostUp = iptables -t nat -A POSTROUTING -o wg-exit -j MASQUERADE

# Allow forwarding
PostUp = iptables -A FORWARD -i tailscale0 -o wg-exit -j ACCEPT
PostUp = iptables -A FORWARD -i wg-exit -o tailscale0 -m state --state RELATED,ESTABLISHED -j ACCEPT
PostUp = iptables -A INPUT -i wg-exit -j ACCEPT
PostUp = iptables -A OUTPUT -o wg-exit -j ACCEPT

# CRITICAL: Prevent Oracle from routing directly to internet (safety mechanism)
# Replace enp0s6 with your actual network interface name (run 'ip addr' to find it)
PostUp = iptables -A OUTPUT -o enp0s6 -m state --state NEW -j REJECT
PostUp = iptables -I OUTPUT 1 -o tailscale0 -j ACCEPT
PostUp = iptables -I OUTPUT 1 -o wg-exit -j ACCEPT
PostUp = iptables -I OUTPUT 1 -o lo -j ACCEPT
PostUp = iptables -I OUTPUT 1 -d 10.0.0.0/24 -j ACCEPT

# Cleanup rules on shutdown
PostDown = iptables -t mangle -D PREROUTING -i tailscale0 ! -d 100.64.0.0/10 -j MARK --set-mark 99
PostDown = iptables -t mangle -D PREROUTING -i tailscale0 ! -d 10.0.0.0/8 -j MARK --set-mark 99
PostDown = ip rule del fwmark 99 table 100 priority 100
PostDown = ip route del default dev wg-exit table 100
PostDown = iptables -t nat -D POSTROUTING -o wg-exit -j MASQUERADE
PostDown = iptables -D FORWARD -i tailscale0 -o wg-exit -j ACCEPT
PostDown = iptables -D FORWARD -i wg-exit -o tailscale0 -m state --state RELATED,ESTABLISHED -j ACCEPT
PostDown = iptables -D INPUT -i wg-exit -j ACCEPT
PostDown = iptables -D OUTPUT -o wg-exit -j ACCEPT
PostDown = iptables -D OUTPUT -o enp0s6 -m state --state NEW -j REJECT
PostDown = iptables -D OUTPUT -o tailscale0 -j ACCEPT
PostDown = iptables -D OUTPUT -o wg-exit -j ACCEPT
PostDown = iptables -D OUTPUT -o lo -j ACCEPT
PostDown = iptables -D OUTPUT -d 10.0.0.0/24 -j ACCEPT

[Peer]
# Akwaba (Director Node)
# Replace <akwaba-public-key> with the public key from Akwaba's /etc/wireguard/akwaba-public.key
PublicKey = <akwaba-public-key>

# Replace with Akwaba's actual Tailscale IP (run 'tailscale status' on Akwaba to get it)
Endpoint = 100.115.73.94:51820

# Route all traffic through this peer
AllowedIPs = 0.0.0.0/0

# Keep connection alive
PersistentKeepalive = 25